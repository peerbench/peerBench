-- Step 1: Create the models table
CREATE TABLE "models" (
	"id" integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY (sequence name "models_id_seq" INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START WITH 1 CACHE 1),
	"provider" varchar(100) NOT NULL,
	"name" varchar(100) NOT NULL,
	"host" text NOT NULL,
	"owner" text NOT NULL,
	"model_id" text NOT NULL,
	"elo" real,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp DEFAULT now() NOT NULL,
	CONSTRAINT "unique_model" UNIQUE("provider","name","host","owner","model_id")
);
--> statement-breakpoint

-- Step 2: Populate models table with existing data from responses
INSERT INTO "models" ("provider", "name", "host", "owner", "model_id", "elo", "created_at", "updated_at")
SELECT DISTINCT 
	r."provider",
	r."model_name",
	r."model_host",
	r."model_owner",
	r."model_id",
	1000,
	NOW(),
	NOW()
FROM "responses" r
WHERE r."provider" IS NOT NULL 
	AND r."model_name" IS NOT NULL 
	AND r."model_host" IS NOT NULL 
	AND r."model_owner" IS NOT NULL 
	AND r."model_id" IS NOT NULL
ON CONFLICT ("provider", "name", "host", "owner", "model_id") DO NOTHING;
--> statement-breakpoint

-- Step 3: Populate models table with existing data from test_results
INSERT INTO "models" ("provider", "name", "host", "owner", "model_id", "elo", "created_at", "updated_at")
SELECT DISTINCT 
	COALESCE(tr."provider", 'unknown'),
	COALESCE(tr."model_name", 'unknown'),
	COALESCE(tr."model_host", 'unknown'),
	COALESCE(tr."model_owner", 'unknown'),
	COALESCE(tr."model_id", 'unknown'),
	1000,
	NOW(),
	NOW()
FROM "test_results" tr
WHERE tr."model_name" IS NOT NULL 
	AND tr."model_host" IS NOT NULL 
	AND tr."model_owner" IS NOT NULL 
	AND tr."model_id" IS NOT NULL
ON CONFLICT ("provider", "name", "host", "owner", "model_id") DO NOTHING;
--> statement-breakpoint

-- Step 4: Populate models table with existing scorer data from scores
INSERT INTO "models" ("provider", "name", "host", "owner", "model_id", "elo", "created_at", "updated_at")
SELECT DISTINCT 
	COALESCE(s."scorer_model_provider", 'unknown'),
	COALESCE(s."scorer_model_name", 'unknown'),
	COALESCE(s."scorer_model_host", 'unknown'),
	COALESCE(s."scorer_model_owner", 'unknown'),
	COALESCE(s."scorer_model_id", 'unknown'),
	1000,
	NOW(),
	NOW()
FROM "scores" s
WHERE s."scorer_model_name" IS NOT NULL 
	AND s."scorer_model_host" IS NOT NULL 
	AND s."scorer_model_owner" IS NOT NULL 
	AND s."scorer_model_id" IS NOT NULL
ON CONFLICT ("provider", "name", "host", "owner", "model_id") DO NOTHING;
--> statement-breakpoint

-- Step 5: Add new integer columns for foreign keys
ALTER TABLE "responses" ADD COLUMN "model_id_new" integer;
--> statement-breakpoint
ALTER TABLE "scores" ADD COLUMN "scorer_model_id_new" integer;
--> statement-breakpoint
ALTER TABLE "test_results" ADD COLUMN "model_id_new" integer;
--> statement-breakpoint

-- Step 6: Update responses with model foreign keys
UPDATE "responses" r
SET "model_id_new" = m."id"
FROM "models" m
WHERE m."provider" = r."provider"
	AND m."name" = r."model_name"
	AND m."host" = r."model_host"
	AND m."owner" = r."model_owner"
	AND m."model_id" = r."model_id";
--> statement-breakpoint

-- Step 7: Update test_results with model foreign keys
UPDATE "test_results" tr
SET "model_id_new" = m."id"
FROM "models" m
WHERE m."provider" = COALESCE(tr."provider", 'unknown')
	AND m."name" = COALESCE(tr."model_name", 'unknown')
	AND m."host" = COALESCE(tr."model_host", 'unknown')
	AND m."owner" = COALESCE(tr."model_owner", 'unknown')
	AND m."model_id" = COALESCE(tr."model_id", 'unknown');
--> statement-breakpoint

-- Step 8: Update scores with scorer model foreign keys
UPDATE "scores" s
SET "scorer_model_id_new" = m."id"
FROM "models" m
WHERE m."provider" = COALESCE(s."scorer_model_provider", 'unknown')
	AND m."name" = COALESCE(s."scorer_model_name", 'unknown')
	AND m."host" = COALESCE(s."scorer_model_host", 'unknown')
	AND m."owner" = COALESCE(s."scorer_model_owner", 'unknown')
	AND m."model_id" = COALESCE(s."scorer_model_id", 'unknown');
--> statement-breakpoint

-- Step 9: Drop the leaderboard view (depends on columns we're about to drop)
DROP VIEW "public"."v_leaderboard";
--> statement-breakpoint

-- Step 10: Drop old columns from responses
ALTER TABLE "responses" DROP COLUMN "provider";
--> statement-breakpoint
ALTER TABLE "responses" DROP COLUMN "model_name";
--> statement-breakpoint
ALTER TABLE "responses" DROP COLUMN "model_host";
--> statement-breakpoint
ALTER TABLE "responses" DROP COLUMN "model_owner";
--> statement-breakpoint
ALTER TABLE "responses" DROP COLUMN "model_id";
--> statement-breakpoint

-- Step 11: Drop old columns from scores
ALTER TABLE "scores" DROP COLUMN "scorer_model_provider";
--> statement-breakpoint
ALTER TABLE "scores" DROP COLUMN "scorer_model_name";
--> statement-breakpoint
ALTER TABLE "scores" DROP COLUMN "scorer_model_host";
--> statement-breakpoint
ALTER TABLE "scores" DROP COLUMN "scorer_model_owner";
--> statement-breakpoint
ALTER TABLE "scores" DROP COLUMN "scorer_model_id";
--> statement-breakpoint

-- Step 12: Drop old columns from test_results
ALTER TABLE "test_results" DROP COLUMN "provider";
--> statement-breakpoint
ALTER TABLE "test_results" DROP COLUMN "model_name";
--> statement-breakpoint
ALTER TABLE "test_results" DROP COLUMN "model_host";
--> statement-breakpoint
ALTER TABLE "test_results" DROP COLUMN "model_owner";
--> statement-breakpoint
ALTER TABLE "test_results" DROP COLUMN "model_id";
--> statement-breakpoint

-- Step 13: Rename new columns to final names
ALTER TABLE "responses" RENAME COLUMN "model_id_new" TO "model_id";
--> statement-breakpoint
ALTER TABLE "scores" RENAME COLUMN "scorer_model_id_new" TO "scorer_model_id";
--> statement-breakpoint
ALTER TABLE "test_results" RENAME COLUMN "model_id_new" TO "model_id";
--> statement-breakpoint

-- Step 14: Set NOT NULL constraint on responses.model_id (it's required)
ALTER TABLE "responses" ALTER COLUMN "model_id" SET NOT NULL;
--> statement-breakpoint

-- Step 15: Add foreign key constraints
ALTER TABLE "responses" ADD CONSTRAINT "responses_model_id_models_id_fk" FOREIGN KEY ("model_id") REFERENCES "public"."models"("id") ON DELETE restrict ON UPDATE cascade;
--> statement-breakpoint
ALTER TABLE "scores" ADD CONSTRAINT "scores_scorer_model_id_models_id_fk" FOREIGN KEY ("scorer_model_id") REFERENCES "public"."models"("id") ON DELETE set null ON UPDATE cascade;
--> statement-breakpoint
ALTER TABLE "test_results" ADD CONSTRAINT "test_results_model_id_models_id_fk" FOREIGN KEY ("model_id") REFERENCES "public"."models"("id") ON DELETE restrict ON UPDATE cascade;
--> statement-breakpoint

-- Step 16: Recreate the leaderboard view
CREATE VIEW "public"."v_leaderboard" AS (select 
    CASE
      WHEN "models"."name" IS NOT NULL THEN "models"."name"
      ELSE "models"."provider"
    END
   as "model", 
    CASE
      WHEN "evaluations"."prompt_set_id" IS NOT NULL THEN "prompt_sets"."title"
      ELSE "evaluations"."protocol_name"
    END
   as "context", 
    CASE
      WHEN "evaluations"."prompt_set_id" IS NULL THEN AVG("evaluations"."score")
      ELSE NULL
    END
   as "avg_score", 
    CASE
      WHEN "evaluations"."prompt_set_id" IS NULL THEN NULL
      ELSE SUM("test_results"."score") / COUNT("test_results"."id")
    END
   as "accuracy", 
    COUNT(DISTINCT "evaluations"."id")
   as "total_evaluations", 
    MAX("evaluations"."finished_at")
   as "recent_evaluation", 
    CASE
      WHEN "evaluations"."prompt_set_id" IS NOT NULL
      THEN COUNT(DISTINCT "prompts"."id")
      ELSE NULL
    END
   as "unique_prompts", 
    COUNT("test_results"."id")
   as "total_tests_performed", 
    CASE
      WHEN "evaluations"."prompt_set_id" IS NULL THEN "evaluations"."protocol_address"
      ELSE NULL
    END
   as "source_protocol_address", "evaluations"."prompt_set_id", "prompts"."type" as "prompt_type" from "test_results" inner join "evaluations" on "test_results"."evaluation_id" = "evaluations"."id" left join "prompt_sets" on "evaluations"."prompt_set_id" = "prompt_sets"."id" left join "prompts" on "test_results"."prompt_id" = "prompts"."id" left join "models" on "test_results"."model_id" = "models"."id" group by "model", "context", "prompts"."type", "evaluations"."prompt_set_id", "source_protocol_address" having (
        (
          CASE WHEN "evaluations"."prompt_set_id" IS NULL
            THEN AVG("evaluations"."score")
            ELSE NULL
          END
        ) > 0
       or 
        (
          CASE WHEN "evaluations"."prompt_set_id" IS NULL
            THEN NULL
            ELSE SUM("test_results"."score") / COUNT("test_results"."id")
          END
        ) > 0
      ));